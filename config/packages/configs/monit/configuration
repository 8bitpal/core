set daemon 60
set logfile syslog facility log_daemon
set mailserver localhost               # primary mailserver
set mail-format { from: monit@buckybox.com }
set alert jordan@buckybox.com                       # receive all alerts
set eventqueue
    basedir /var/monit  # set the base directory where events will be stored
    slots 100           # optionaly limit the queue size
set httpd port 2812 and
   use address localhost  # only accept connection from localhost
   allow localhost        # allow localhost to connect to the server and
   allow admin:'@dr1nk'      # require user 'admin' with password 'monit'
check system localhost
  if loadavg (1min) > 4 then alert
  if loadavg (5min) > 2 then alert
  if memory usage > 75% then alert
  if cpu usage (user) > 70% then alert
  if cpu usage (system) > 30% then alert
  if cpu usage (wait) > 20% then alert
check process nginx with pidfile /var/run/nginx.pid
  start program = "/etc/init.d/nginx start"
  stop program = "/etc/init.d/nginx stop"
#if children > 250 then restart
#if loadavg(5min) greater than 10 for 8 cycles then stop
#if 3 restarts within 5 cycles then timeout

check process postgres with pidfile /var/lib/postgresql/9.1/main/postmaster.pid
  start program = "/etc/init.d/postgresql start"
  stop program  = "/etc/init.d/postgresql stop"
#  include /etc/monit.d/*

# an example Monit configuration file for delayed_job
# See: http://stackoverflow.com/questions/1226302/how-to-monitor-delayedjob-with-monit/1285611
#
# To use:
# 1. copy to /var/www/apps/{app_name}/shared/delayed_job.monitrc
# 2. replace {app_name} as appropriate
# 3. add this to your /etc/monit/monitrc
#
#   include /var/www/apps/{app_name}/shared/delayed_job.monitrc

#PRODUCTION
check process delayed_job
  with pidfile /home/buckybox/production/shared/pids/delayed_job.pid
  start program = "/usr/bin/env RAILS_ENV=production /home/buckybox/production/current/script/delayed_job start"
  stop program = "/usr/bin/env RAILS_ENV=production /home/buckybox/production/current/script/delayed_job stop"
  start program = "/bin/su - buckybox -c 'cd /home/buckybox/production/current/; RAILS_ENV=production script/delayed_job start'"
  stop program = "/bin/su - buckybox -c 'cd /home/buckybox/production/current/; RAILS_ENV=production script/delayed_job stop'"
#PRODUCTION
#STAGING
check process delayed_job
  with pidfile /home/buckybox/staging/shared/pids/delayed_job.pid
  start program = "/bin/su - buckybox -c 'cd /home/buckybox/staging/current/; RAILS_ENV=staging script/delayed_job start'"
  stop program = "/bin/su - buckybox -c 'cd /home/buckybox/staging/current/; RAILS_ENV=staging script/delayed_job stop'"
#STAGING
