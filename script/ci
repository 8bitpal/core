#!/bin/bash -ex

export CI=1
export RAILS_ENV=test
export COVERAGE=1

[ "$1" = "--fast" ] && FAST="1"

cp -n config/database.yml{.example,}

[ -n "$SNAP_CI" ] && bundle install --jobs=3 --retry=3 --deployment

[ -z "$FAST" ] && {
  export SPEC_OPTS="--format p"

  output="$(git submodule update --remote)"
  echo -n "$output"
  test -z "$output"

  bundle exec bundle-audit update
  bundle exec bundle-audit check

  bundle exec rubocop -DES
  $(dirname $0)/check_i18n

  bundle exec discover-unused-partials || true
  bundle exec brakeman -qz --no-progress -w3 || true # FIXME
  bundle exec cane --no-doc --style-measure 160 --abc-max 30 || true # FIXME

  bundle exec rake generate_secret_token
}

bundle exec rake db:drop db:create db:structure:load
bundle exec rake

