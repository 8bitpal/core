require 'csv'

class BankStatement < ActiveRecord::Base

  belongs_to :distributor

  mount_uploader :statement_file, BankStatementUploader

  def process_statement!(customers_ids)
    it=0
    CSV.foreach(statement_file.path, :headers => :first_row) do |row|
      if row['Amount'].to_i > 0
        create_payment!(row, customers_ids[it.to_s]) unless customers_ids[it.to_s].blank?
        it+=1
      end
    end
  end

  # CSV line format
  # "Date", "Amount", "Payee", "Particulars", "Code", "Reference", "Tran Type"
  private
  def create_payment!(row, customer_id)
    account = distributor.accounts.where('customer_id = ?', customer_id).first
    account = Account.create!(distributor: distributor, customer: Customer.find(customer_id)) unless account
    Payment.create!(distributor: distributor, account: account, kind: "bank_transfer", description: "Payment generated by CSV import", amount: row['Amount'], statement_id: id)
  end
end
